name: Emulador Android

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  start-emulator:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
      - name: Instalar dependÃªncias do AVD
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils mesa-utils

      - name: Instalar system image
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "system-images;android-30;google_apis;x86_64" \
            "platform-tools" \
            "emulator"

      - name: Criar AVD
        run: |
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n test -k "system-images;android-30;google_apis;x86_64" \
            --device "pixel"

      - name: Iniciar emulador Android (modo software)
        run: |
          $ANDROID_HOME/emulator/emulator -avd test \
            -no-audio -no-window -gpu swiftshader_indirect \
            -no-boot-anim -no-snapshot \
            -qemu -accel tcg &

          echo "Aguardando o emulador inicializar..."
          $ANDROID_HOME/platform-tools/adb wait-for-device
          $ANDROID_HOME/platform-tools/adb shell input keyevent 82


      - name: Tirar screenshot
        run: adb exec-out screencap -p > screenshot.png

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: emulator-screenshot
          path: screenshot.png

      - name: Keep Alive
        run: |
          echo "Emulador rodando por 5 minutos..."
          sleep 300
