name: Emulador Android

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  run-emulator:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_AVD_HOME: $HOME/.android/avd
      PATH: $ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH


    steps:
      - name: Setup packages (qemu, etc)
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils mesa-utils

      - name: Accept licenses and install system images
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "emulator" "system-images;android-30;google_apis;x86_64"

      - name: Create AVD
        run: |
          mkdir -p $ANDROID_AVD_HOME
          echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64" --device "pixel"

      - name: Check AVD files
        run: |
          ls -l $ANDROID_AVD_HOME
          cat $ANDROID_AVD_HOME/test.ini

      - name: List AVDs
        run: emulator -list-avds

      - name: Start emulator
        run: |
          emulator -avd test -no-audio -no-window -gpu swiftshader_indirect -no-boot-anim -qemu -accel tcg &

          echo "Esperando o emulador iniciar..."
          adb wait-for-device
          adb shell input keyevent 82

      - name: Check emulator status
        run: adb devices
      - name: Tirar screenshot
        run: adb exec-out screencap -p > screenshot.png

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: emulator-screenshot
          path: screenshot.png

      - name: Keep Alive
        run: |
          echo "Emulador rodando por 5 minutos..."
          sleep 300
